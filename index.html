<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <!-- Viewport ottimizzato: user-scalable=no previene zoom accidentali, ma va usato con cautela per accessibilità. 
         Qui usiamo lo standard sicuro che permette lo zoom manuale ma imposta la scala corretta. -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <!-- Meta tag specifici per iOS / Apple Web App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">

    <title>Siete invitati | Elena & Ugo</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Stile di base e font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap');
        
        :root {
            --color-primary: #5D7050;      
            --color-secondary: #C4D2B2;    
            --color-accent: #E8B446;       
            --color-background: #FAF8F2;   
            
            --font-serif: 'Playfair Display', serif;
            --font-sans: 'Inter', sans-serif;
        }

        /* --- OTTIMIZZAZIONI APPLE / IOS --- */
        body {
            font-family: var(--font-sans);
            background-color: var(--color-background);
            color: #222;
            
            /* Rendering testo nitido su schermi Retina (Apple) */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            
            /* Gestione Notch (iPhone X e successivi) */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* Rimuove l'highlight grigio al tocco su iOS */
        a, button, input, select, textarea {
            -webkit-tap-highlight-color: transparent;
        }

        /* Reset stili nativi iOS per input e bottoni */
        input, textarea, select, button {
            -webkit-appearance: none;
            appearance: none;
            border-radius: 0.375rem; /* Forza il border-radius di Tailwind */
        }

        /* FIX CRITICO IOS: Previene lo zoom automatico sui campi di input */
        @media screen and (max-width: 768px) {
            input, textarea, select {
                font-size: 16px !important; 
            }
        }

        .header-font {
            font-family: var(--font-serif);
        }

        /* 1. Contenitore principale dell'Header */
        .wedding-bg {
            position: relative;
            min-height: 100vh;
            z-index: 1; 
            overflow: hidden; /* Mantiene pulito il layout */
        }
        
        /* 2. Sfondo Parallax Ottimizzato per iOS (Position Fixed invece di Background-Attachment Fixed) */
        .wedding-bg::before {
            content: '';
            position: fixed; /* FIX: Usa fixed positioning per fluidità su iOS */
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh; /* Copre intero viewport */
            
            background: url('https://images.unsplash.com/photo-1561287495-a3fe1fd28504?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w3NDE5ODJ8MHwxfHNlYXJjaHw5fHx3ZWRkaW5nJTIwY291cGxlfGVufDB8fHx8MTc2MzIzODI3MHww&ixlib=rb-4.1.0&q=80&q=75&w=1080') center/cover no-repeat;
            
            /* Rimuoviamo background-attachment: fixed che causa jitter su iOS */
            background-attachment: scroll; 
            
            filter: blur(3px); 
            z-index: -1; 
            will-change: transform; /* Hint per la GPU Apple per prestazioni migliori */
            transform: translateZ(0); /* Attiva accelerazione hardware */
        }
        
        /* 3. Effetto Vetro (Glassmorphism) con supporto Apple */
        .glass-box {
            position: relative;
            z-index: 2;
            background-color: rgba(255, 255, 255, 0.5); 
            
            /* Supporto standard e WebKit (Safari/iOS) */
            backdrop-filter: blur(8px); 
            -webkit-backdrop-filter: blur(8px);
            
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #222; 
        }

        /* Stili pulsanti */
        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .btn-primary:hover {
            background-color: #4A5B3E;
            box-shadow: 0 4px 15px rgba(93, 112, 80, 0.5);
            transform: translateY(-2px);
        }
        
        .btn-primary:active {
            transform: translateY(0); /* Feedback tattile immediato */
        }

        .drop-area {
            border: 4px dashed var(--color-secondary);
            background-color: #ffffff;
            transition: all 0.2s;
        }
        
        .drop-area.highlight {
            border-color: var(--color-primary);
            background-color: #f7f9f7;
        }
    </style>
</head>
<body class="scroll-smooth">

    <!-- HEADER / HERO -->
    <header class="wedding-bg flex flex-col justify-center items-center p-8 text-center" id="home">
        
        <div class="glass-box p-8 md:p-12 max-w-lg w-full rounded-2xl shadow-2xl"> 
            
            <p class="text-xl text-gray-800 mb-2 header-font italic">Siete invitati al matrimonio di</p>
            
            <h1 class="header-font text-5xl md:text-7xl text-[var(--color-primary)] font-bold mb-6 tracking-tight leading-none flex justify-center items-center flex-wrap">
                <span>Elena</span> 
                <span class="text-gray-600 font-normal mx-3 text-5xl md:text-7xl">&</span> 
                <span>Ugo</span>
            </h1>
            
            <p class="text-2xl text-gray-800 font-medium mb-12">30 Maggio 2026</p>

            <!-- Conto alla rovescia -->
            <div id="countdown" class="flex justify-center space-x-4 md:space-x-8 text-gray-800 bg-white p-4 rounded-lg shadow-xl">
                <div class="flex flex-col items-center">
                    <span id="days" class="text-3xl font-bold text-[var(--color-primary)]">00</span>
                    <span class="text-xs uppercase mt-1">Giorni</span>
                </div>
                <div class="flex flex-col items-center">
                    <span id="hours" class="text-3xl font-bold text-[var(--color-primary)]">00</span>
                    <span class="text-xs uppercase mt-1">Ore</span>
                </div>
                <div class="flex flex-col items-center">
                    <span id="minutes" class="text-3xl font-bold text-[var(--color-primary)]">00</span>
                    <span class="text-xs uppercase mt-1">Minuti</span>
                </div>
                <div class="flex flex-col items-center">
                    <span id="seconds" class="text-3xl font-bold text-[var(--color-primary)]">00</span>
                    <span class="text-xs uppercase mt-1">Secondi</span>
                </div>
            </div>
            <p id="countdown-message" class="text-lg mt-4 font-semibold text-[var(--color-primary)] hidden">È IL GRANDE GIORNO!</p>

        </div>
    </header>

    <!-- NAVIGAZIONE STICKY (Ordine aggiornato: Info -> RSVP -> Foto) -->
    <nav class="sticky top-0 z-50 bg-white/90 backdrop-blur-md shadow-lg border-t-4 border-[var(--color-primary)] supports-[backdrop-filter]:bg-white/60">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-center h-16">
                <a href="#info" class="text-gray-600 hover:text-[var(--color-primary)] px-5 py-2 rounded-md text-base font-medium transition duration-150 flex items-center h-full">Info</a>
                <a href="#guestbook" class="text-gray-600 hover:text-[var(--color-primary)] px-5 py-2 rounded-md text-base font-medium transition duration-150 flex items-center h-full">RSVP</a>
                <a href="#upload-foto" class="text-gray-600 hover:text-[var(--color-primary)] px-5 py-2 rounded-md text-base font-medium transition duration-150 flex items-center h-full">Foto</a>
            </div>
        </div>
    </nav>

    <!-- SEZIONE INFO -->
    <section id="info" class="py-16 md:py-24 bg-[var(--color-background)] relative z-10">
        <div class="max-w-5xl mx-auto px-4 text-center">
            <h2 class="header-font text-4xl md:text-5xl font-bold mb-12 text-gray-800 border-b-2 border-[var(--color-primary)] inline-block pb-2">Informazioni Utili</h2>

            <div class="space-y-8">
                <!-- Riga 1: Cerimonia e Ricevimento -->
                <div class="grid md:grid-cols-2 gap-8">
                    
                    <!-- Cerimonia Card -->
                    <div class="bg-white p-8 rounded-xl shadow-lg border-t-4 border-[var(--color-secondary)] transform transition duration-300 hover:scale-[1.02]">
                        <i class="fas fa-handshake text-4xl text-[var(--color-primary)] mb-4"></i>
                        <h3 class="header-font text-3xl font-semibold mb-3">Cerimonia</h3>
                        <p class="text-gray-600 mb-2 font-medium">Ore 12:00</p>
                        <p class="text-gray-600 mb-4 font-bold">Ristorante Symposio</p>
                        <p class="text-sm text-gray-500">Via Loreggiola, 163, 35010 Loreggia PD</p>
                        <a href="https://www.google.com/maps/search/?api=1&query=Ristorante+Symposio,+Via+Loreggiola,+163,+35010+Loreggia+PD" 
                           target="_blank" class="text-[var(--color-primary)] hover:underline font-medium mt-3 inline-block">
                            Vedi sulla mappa <i class="fas fa-map-marker-alt ml-1"></i>
                        </a>
                    </div>
    
                    <!-- Ricevimento Card -->
                    <div class="bg-white p-8 rounded-xl shadow-lg border-t-4 border-[var(--color-primary)] transform transition duration-300 hover:scale-[1.02]">
                        <i class="fas fa-glass-cheers text-4xl text-[var(--color-primary)] mb-4"></i>
                        <h3 class="header-font text-3xl font-semibold mb-3">Ricevimento</h3>
                        <p class="text-gray-600 mb-2 font-medium">A seguire (Ore 14:00)</p>
                        <p class="text-gray-600 mb-4 font-bold">Ristorante Symposio</p>
                        <p class="text-sm text-gray-500">Via Loreggiola, 163, 35010 Loreggia PD</p>
                        <a href="https://www.google.com/maps/search/?api=1&query=Ristorante+Symposio,+Via+Loreggiola,+163,+35010+Loreggia+PD" 
                           target="_blank" class="text-[var(--color-primary)] hover:underline font-medium mt-3 inline-block">
                            Vedi sulla mappa <i class="fas fa-map-marker-alt ml-1"></i>
                        </a>
                    </div>
                </div>
                
                <!-- Riga 2: Un piccolo pensiero (EX Lista Nozze) -->
                <div class="flex justify-center pt-4">
                    <div class="w-full md:w-2/3 lg:w-1/2">
                        <div class="bg-white p-8 rounded-xl shadow-lg border-t-4 border-[var(--color-secondary)]">
                            <i class="fas fa-gift text-4xl text-[var(--color-primary)] mb-4"></i>
                            <h3 class="header-font text-3xl font-semibold mb-3">Un piccolo pensiero</h3>
                            <p class="text-gray-600 mb-6 text-sm">
                                La vostra presenza è il regalo più grande! Ma se desiderate farci un pensiero, gradiremmo un contributo per la nostra luna di miele da sogno.
                            </p>
                            <button onclick="document.getElementById('iban_details').classList.toggle('hidden')" class="btn-primary py-2 px-6 rounded-full font-bold shadow-md hover:shadow-xl transition duration-300 text-sm w-full sm:w-auto">
                                Vedi Dettagli IBAN
                            </button>
                            <div id="iban_details" class="mt-4 p-3 bg-gray-100 rounded-lg hidden text-left animate-fade-in-down">
                                <p class="text-sm font-mono break-all text-center sm:text-left">IT00 A000 0000 0000 0000 0000 00</p>
                                <p class="text-xs mt-1 text-gray-500 text-center sm:text-left">Intestato a: Contributo Viaggio</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- SEZIONE RSVP / GUESTBOOK (Spostata prima delle Foto) -->
    <section id="guestbook" class="py-16 md:py-24 bg-[var(--color-background)] relative z-10">
        <div class="max-w-5xl mx-auto px-4 text-center">
            <h2 class="header-font text-4xl md:text-5xl font-bold mb-12 text-gray-800 border-b-2 border-[var(--color-primary)] inline-block pb-2">Conferma Presenza (RSVP)</h2>
            <p class="text-lg text-gray-600 mb-8 max-w-3xl mx-auto">
                La tua presenza renderà il nostro giorno ancora più speciale. Per favore, compila il modulo qui sotto. La conferma è richiesta entro il **30 Aprile 2026**.
            </p>
            
            <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-3xl mx-auto">
                <h3 class="text-2xl font-bold text-[var(--color-primary)] mb-6">Dettagli Presenza</h3>
                
                <div id="rsvp-content">
                    <form id="rsvp-form" class="space-y-4 text-left">
                        <div>
                            <label for="guest-name" class="block text-sm font-medium text-gray-700">Il tuo Nome (Contatto Principale)</label>
                            <input type="text" id="guest-name" required placeholder="Es. Mario Rossi e famiglia" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-[var(--color-primary)] focus:ring-[var(--color-primary)]">
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="adult-count" class="block text-sm font-medium text-gray-700">Numero di Adulti (incluso te)</label>
                                <input type="number" id="adult-count" required min="0" value="0" 
                                    onfocus="if (this.value === '0') this.value = '';" 
                                    onblur="if (this.value === '') this.value = '0';"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-[var(--color-primary)] focus:ring-[var(--color-primary)]">
                            </div>
                            <div>
                                <label for="children-count" class="block text-sm font-medium text-gray-700">Numero di Bambini (<12 anni)</label>
                                <input type="number" id="children-count" required min="0" value="0" 
                                    onfocus="if (this.value === '0') this.value = '';" 
                                    onblur="if (this.value === '') this.value = '0';"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-[var(--color-primary)] focus:ring-[var(--color-primary)]">
                            </div>
                        </div>
                        
                        <div id="individual-guests-container" class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <p class="text-sm font-medium text-gray-500 text-center">Inserisci il numero di adulti e bambini per specificare i dettagli individuali.</p>
                        </div>

                        <div>
                            <label for="guest-message" class="block text-sm font-medium text-gray-700">Note Aggiuntive o RSVP Negativo</label>
                            <textarea id="guest-message" rows="3" placeholder="Scrivi 'RSVP Negativo' se non puoi venire. Altrimenti, usa questo spazio per note extra (es. necessità di seggiolone)." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-[var(--color-primary)] focus:ring-[var(--color-primary)]"></textarea>
                        </div>

                        <button type="submit" id="submitRsvp" class="btn-primary w-full py-3 mt-4 rounded-full font-bold text-lg">
                            <i class="fas fa-paper-plane mr-2"></i> Invia Conferma Presenza
                        </button>
                    </form>

                    <div id="status-message-guestbook" class="mt-4 p-3 rounded-md hidden"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- SEZIONE UPLOAD FOTO (FIXED) -->
    <section id="upload-foto" class="py-16 md:py-24 bg-white relative z-10">
        <div class="max-w-3xl mx-auto px-4 text-center">
            <h2 class="header-font text-4xl md:text-5xl font-bold mb-12 text-gray-800 border-b-2 border-[var(--color-primary)] inline-block pb-2">Condividi le tue Foto!</h2>
            <p class="text-lg text-gray-600 mb-8 max-w-2xl mx-auto">
                Aiutaci a raccogliere i momenti più belli della giornata. Carica qui i tuoi scatti direttamente dal tuo smartphone.
            </p>

            <form id="uploadForm" class="bg-[var(--color-background)] p-6 md:p-8 rounded-xl shadow-2xl space-y-4 text-left">
                
                <!-- Rimosso onclick="...click()" dal div container per evitare doppi click -->
                <div class="drop-area flex flex-col items-center justify-center p-8 md:p-12 text-center rounded-lg cursor-pointer active:bg-gray-100 transition border-4 border-dashed border-[var(--color-secondary)] hover:border-[var(--color-primary)] bg-white">
                    <i class="fas fa-cloud-upload-alt text-4xl text-[var(--color-primary)] mb-4"></i>
                    <p class="font-semibold text-gray-700">Tocca qui per selezionare le foto</p>
                    <p class="text-sm text-gray-500">JPG, PNG. Max 5MB a file.</p>
                    
                    <input type="file" id="mediaFile" name="mediaFile" accept="image/*" class="hidden" multiple>
                    <!-- Gestito via JS -->
                    <button type="button" id="btnSelectFiles" class="btn-primary py-2 px-6 rounded-full font-bold mt-4 shadow-md text-sm pointer-events-none">
                        Scegli dalla Galleria
                    </button>
                </div>
                
                <!-- Area anteprima file selezionati -->
                <div id="file-info" class="text-sm text-gray-600 text-center pt-2 hidden"></div>
                
                <div>
                    <label for="uploader-name" class="block text-sm font-medium text-gray-700">Il tuo Nome (Facoltativo)</label>
                    <input type="text" id="uploader-name" placeholder="Es. Giuseppe Verdi" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-[var(--color-primary)] focus:ring-[var(--color-primary)]">
                </div>

                <button type="submit" id="uploadButton" class="btn-primary w-full py-3 mt-4 rounded-full font-bold text-lg" disabled>
                    Carica Foto
                </button>

                <div id="statusMessage" class="mt-4 p-3 rounded-md hidden text-center text-sm font-medium"></div>

                <div id="progress-bar-container" class="w-full h-3 rounded-full overflow-hidden mt-4 hidden bg-gray-200">
                    <div id="progress-bar" class="h-full transition-all duration-300" style="width: 0%; background-color: var(--color-primary);"></div>
                </div>
                <p id="progress-text" class="text-sm text-gray-600 mt-2 text-center hidden"></p>

            </form>
        </div>
    </section>
    
    <!-- FOOTER -->
    <footer class="bg-gray-800 text-white p-8 text-center relative z-10">
        <p class="text-sm">&copy; 2024 Elena & Ugo. Non vediamo l'ora di festeggiare con voi!</p>
        <p class="text-xs mt-2 text-gray-400">Eternal Vows | Creato con ❤️.</p>
        
        <!-- SEZIONE ADMIN -->
        <div class="absolute right-4 bottom-4">
            <button id="admin-trigger" class="text-gray-400 hover:text-[var(--color-accent)] transition duration-200 focus:outline-none p-2">
                <i class="fas fa-lock text-xl"></i>
            </button>
            <div id="admin-panel" class="absolute bottom-10 right-0 w-64 bg-white p-4 rounded-lg shadow-2xl text-gray-800 hidden text-left z-50">
                <h4 class="font-bold text-lg mb-2 text-[var(--color-primary)] flex items-center">
                    <i class="fas fa-user-shield mr-2"></i> Area Admin
                </h4>
                <div id="admin-login-area">
                    <label for="admin-pin" class="block text-sm font-medium mb-1">Inserisci PIN</label>
                    <input type="password" id="admin-pin" placeholder="****" class="w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:border-[var(--color-primary)] focus:ring-[var(--color-primary)]">
                    <button id="pin-submit" class="btn-primary w-full py-2 mt-3 rounded-lg font-semibold text-sm">
                        Accedi
                    </button>
                    <p id="admin-status" class="text-xs mt-2 text-red-500 hidden"></p>
                </div>
                <div id="admin-download-area" class="hidden">
                    <p class="text-sm font-medium mb-3 text-green-600">Accesso Admin Riuscito!</p>
                    <button id="download-rsvp" class="bg-[var(--color-accent)] text-gray-800 hover:bg-[#D4A33B] w-full py-2 rounded-lg font-bold text-sm transition duration-300 shadow-md">
                        <i class="fas fa-file-excel mr-2"></i> Scarica Dati RSVP
                    </button>
                    <span id="download-status" class="block mt-2 text-xs font-medium text-gray-600 hidden"></span>
                </div>
            </div>
        </div>
    </footer>
    
    <script type="module">
        // --- CONFIGURAZIONE GOOGLE APPS SCRIPT ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx10cspPJCB6l066D1xWqibJrY0UkJ0UYoCtZ8dRHjk0ipNTjICPed2-mxXJ_5aAlE5yg/exec'; 
        
        // --- CONFIGURAZIONE STANDALONE ---
        const appId = 'wedding-app-default';
        let userId = 'AnonGuest_' + crypto.randomUUID(); 
        let mockRsvpDataStore = [];
        
        // --- VARIABILI CONTO ALLA ROVESCIA (Countdown) ---
        const targetDate = new Date("May 30, 2026 12:00:00").getTime(); 
        const daysSpan = document.getElementById('days');
        const hoursSpan = document.getElementById('hours');
        const minutesSpan = document.getElementById('minutes');
        const secondsSpan = document.getElementById('seconds');
        const countdownMessage = document.getElementById('countdown-message');

        // Elementi DOM per il form RSVP
        const rsvpForm = document.getElementById('rsvp-form');
        const guestNameInput = document.getElementById('guest-name');
        const adultCountInput = document.getElementById('adult-count');
        const childrenCountInput = document.getElementById('children-count');
        const guestsContainer = document.getElementById('individual-guests-container');
        const messageInput = document.getElementById('guest-message');
        const submitRsvpButton = document.getElementById('submitRsvp');

        // --- FUNZIONI DI UTILITÀ ---
        function alertUserGuestbook(message, type) {
            const statusDiv = document.getElementById('status-message-guestbook');
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
            
            if (type === 'success') {
                statusDiv.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                statusDiv.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'info') {
                 statusDiv.classList.add('bg-blue-100', 'text-blue-700');
            }
            statusDiv.classList.remove('hidden');
        }

        // --- LOGICA GENERAZIONE CAMPI DINAMICI ---
        function updateIndividualGuestFields() {
            const adultCount = parseInt(adultCountInput.value, 10) || 0;
            const childrenCount = parseInt(childrenCountInput.value, 10) || 0;
            const totalGuests = adultCount + childrenCount;
            guestsContainer.innerHTML = ''; 

            if (totalGuests === 0) {
                guestsContainer.innerHTML = `
                    <p class="text-sm font-medium text-gray-500 text-center">
                        Inserisci il numero di adulti e bambini. Se non potete partecipare, scrivete 'RSVP Negativo' nelle note.
                    </p>`;
                return;
            }
            
            const title = document.createElement('h4');
            title.className = 'text-lg font-semibold text-gray-700 mb-4 border-b pb-2';
            title.textContent = `Dettagli per ${totalGuests} Persona/e (Nome e Intolleranze)`;
            guestsContainer.appendChild(title);

            for (let i = 0; i < totalGuests; i++) {
                const isChild = i >= adultCount;
                const guestType = isChild ? 'Bambino/a' : 'Adulto/a';
                const guestNumber = isChild ? (i - adultCount + 1) : (i + 1);
                
                let defaultName = '';
                if (i === 0 && !isChild) {
                    defaultName = guestNameInput.value.split(' ')[0] || '';
                }

                const fieldGroup = document.createElement('div');
                fieldGroup.className = 'space-y-2 p-3 border-l-4 border-[var(--color-secondary)] bg-white rounded-md shadow-sm mb-4';
                fieldGroup.innerHTML = `
                    <p class="text-sm font-bold text-[var(--color-primary)]">${guestType} #${guestNumber}</p>
                    <input type="hidden" name="guest-type" value="${guestType}" />
                    <input type="hidden" name="guest-age" value="${isChild ? '<12' : '>12'}" />
                    <div>
                        <label class="block text-xs font-medium text-gray-700">Nome Completo (Necessario per il Tableau)</label>
                        <input type="text" name="guest-name-field" value="${defaultName}" required 
                               placeholder="Nome e Cognome"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:border-[var(--color-primary)] focus:ring-[var(--color-primary)]">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700">Allergie / Intolleranze / Restrizioni (Es. Vegetariano)</label>
                        <input type="text" name="guest-allergies" placeholder="Nessuna"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:border-[var(--color-primary)] focus:ring-[var(--color-primary)]">
                    </div>
                `;
                guestsContainer.appendChild(fieldGroup);
            }
        }
        
        // --- LOGICA DI DOWNLOAD CSV (ADMIN) ---
        function downloadAllRsvpData() {
            const downloadStatus = document.getElementById('download-status');
            
            if (mockRsvpDataStore.length === 0) {
                 downloadStatus.textContent = `⚠️ Nessun RSVP inviato finora per il download.`;
                 downloadStatus.classList.remove('hidden', 'text-blue-700', 'text-green-700');
                 downloadStatus.classList.add('text-red-700');
                 return;
            }
            
            downloadStatus.classList.remove('hidden', 'text-red-700', 'text-green-700');
            downloadStatus.textContent = "Preparazione e download del file CSV in corso...";
            downloadStatus.classList.add('text-blue-700');

            const headers = ["Nome Contatto Principale", "Totale Adulti", "Totale Bambini", "Totale Ospiti", "RSVP Negativo", "Messaggio/Note", "Nome Ospite Individuale", "Età Ospite (<12/>12)", "Allergie/Intolleranze", "Data Invio"];
            let csvContent = headers.join(";") + "\n";
            
            const escapeValue = (value) => {
                if (value === null || value === undefined) return "";
                let str = String(value).replace(/"/g, '""');
                if (str.includes(';') || str.includes('\n') || str.includes(',')) {
                    str = `"${str}"`;
                }
                return str;
            };

            mockRsvpDataStore.forEach(rsvpData => {
                const mainContact = escapeValue(rsvpData.contactName);
                const totalAdults = rsvpData.adults;
                const totalChildren = rsvpData.children;
                const totalGuests = rsvpData.totalGuests;
                const isNegative = rsvpData.isRsvpNegative ? 'SI' : 'NO';
                const message = escapeValue(rsvpData.message);
                const timestamp = rsvpData.timestamp;

                if (rsvpData.isRsvpNegative) {
                    const row = [mainContact, totalAdults, totalChildren, totalGuests, isNegative, message, "", "", "", timestamp];
                    csvContent += row.map(escapeValue).join(";") + "\n";
                } else {
                    rsvpData.guests.forEach((guest, index) => {
                        const contactInfo = index === 0 ? [mainContact, totalAdults, totalChildren, totalGuests, isNegative, message] : ["", "", "", "", "", ""];
                        const guestRow = [escapeValue(guest.name), escapeValue(guest.age), escapeValue(guest.allergies)];
                        const row = [...contactInfo, ...guestRow, timestamp];
                        csvContent += row.map(escapeValue).join(";") + "\n";
                    });
                    if (rsvpData.guests.length === 0 && totalGuests > 0) {
                        const row = [mainContact, totalAdults, totalChildren, totalGuests, isNegative, message, "N/A - Dettagli Mancanti", "", "", timestamp];
                        csvContent += row.map(escapeValue).join(";") + "\n";
                    }
                }
            });
            
            const bom = '\ufeff'; 
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `RSVP_Elena_Ugo_${new Date().toLocaleDateString('it-IT').replace(/\//g, '-')}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                downloadStatus.textContent = `✅ File CSV (Excel) generato e scaricato.`;
                downloadStatus.classList.remove('text-blue-700');
                downloadStatus.classList.add('text-green-700');
            }
        }

        // --- LOGICA DI INVIO FORM (MOCK) ---
        rsvpForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitRsvpButton.disabled = true;
            submitRsvpButton.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> Invio...';
            alertUserGuestbook('Raccolta e invio della conferma in corso...', 'info');

            try {
                const contactName = guestNameInput.value.trim();
                const adultCount = parseInt(adultCountInput.value, 10) || 0;
                const childrenCount = parseInt(childrenCountInput.value, 10) || 0;
                const guestMessage = messageInput.value.trim();
                const totalGuests = adultCount + childrenCount;
                let isRsvpNegative = false;

                if (totalGuests === 0 && guestMessage.toLowerCase().includes('negativo')) {
                    isRsvpNegative = true;
                } else if (totalGuests === 0 && !guestMessage) {
                    throw new Error("Per favore, inserisci i partecipanti o 'RSVP Negativo'.");
                }

                const individualGuestsData = [];
                if (!isRsvpNegative) {
                    const guestFields = guestsContainer.querySelectorAll('.space-y-2');
                    guestFields.forEach(group => {
                        const nameInput = group.querySelector('input[name="guest-name-field"]');
                        if (!nameInput.value.trim()) throw new Error("Inserisci il nome per tutti gli ospiti.");
                        individualGuestsData.push({
                            type: group.querySelector('input[name="guest-type"]').value,
                            age: group.querySelector('input[name="guest-age"]').value,
                            name: nameInput.value.trim(),
                            allergies: group.querySelector('input[name="guest-allergies"]').value.trim() || 'Nessuna',
                        });
                    });
                }

                const rsvpData = {
                    contactUserId: userId, contactName, adults: adultCount, children: childrenCount,
                    totalGuests, message: guestMessage, isRsvpNegative, guests: individualGuestsData,
                    timestamp: new Date().toISOString(),
                };
                
                mockRsvpDataStore.push(rsvpData);
                await new Promise(r => setTimeout(r, 1000));

                alertUserGuestbook('✅ Conferma inviata con successo. Grazie!', 'success');
                guestsContainer.innerHTML = `<p class="text-lg font-bold text-green-700 text-center">Grazie! La tua conferma di presenza è stata inviata.</p>`;
                submitRsvpButton.innerHTML = '<i class="fas fa-check mr-2"></i> Inviato!';
                submitRsvpButton.disabled = true;

            } catch (error) {
                alertUserGuestbook(error.message, 'error');
                submitRsvpButton.disabled = false;
                submitRsvpButton.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Riprova Invio';
            }
        });
        
        // --- LOGICA ADMIN (PIN 2026) ---
        const adminTrigger = document.getElementById('admin-trigger');
        const adminPanel = document.getElementById('admin-panel');
        const adminPinInput = document.getElementById('admin-pin');
        const pinSubmitButton = document.getElementById('pin-submit');
        const adminStatus = document.getElementById('admin-status');
        const downloadRsvpButton = document.getElementById('download-rsvp');
        
        const CORRECT_PIN = "2026"; 
        
        adminTrigger.addEventListener('click', () => {
            adminPanel.classList.toggle('hidden');
            if (!adminPanel.classList.contains('hidden')) adminPinInput.focus();
        });
        
        pinSubmitButton.addEventListener('click', () => {
            if (adminPinInput.value === CORRECT_PIN) {
                document.getElementById('admin-login-area').classList.add('hidden');
                document.getElementById('admin-download-area').classList.remove('hidden');
                adminTrigger.innerHTML = '<i class="fas fa-unlock text-xl text-[var(--color-accent)]"></i>';
            } else {
                adminStatus.textContent = 'PIN errato. Riprova.';
                adminStatus.classList.remove('hidden');
            }
        });
        
        downloadRsvpButton.addEventListener('click', downloadAllRsvpData);

        // --- COUNTDOWN ---
        function updateCountdown() {
            const now = new Date().getTime();
            const distance = targetDate - now;

            if (distance < 0) {
                clearInterval(countdownInterval);
                document.getElementById('countdown').classList.add('hidden');
                countdownMessage.classList.remove('hidden');
                return;
            }
            daysSpan.textContent = Math.floor(distance / (1000 * 60 * 60 * 24)).toString().padStart(2, '0');
            hoursSpan.textContent = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)).toString().padStart(2, '0');
            minutesSpan.textContent = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
            secondsSpan.textContent = Math.floor((distance % (1000 * 60)) / 1000).toString().padStart(2, '0');
        }
        let countdownInterval = setInterval(updateCountdown, 1000);
        updateCountdown();

        // --- AVVIO APP ---
        document.addEventListener('DOMContentLoaded', () => {
            adultCountInput.addEventListener('change', updateIndividualGuestFields);
            childrenCountInput.addEventListener('change', updateIndividualGuestFields);
            guestNameInput.addEventListener('input', updateIndividualGuestFields); 
            updateIndividualGuestFields(); 
        });

        // --- NUOVA LOGICA UPLOAD FOTO (FIXED) ---
        const mediaFileInput = document.getElementById('mediaFile');
        const fileInfoDiv = document.getElementById('file-info');
        const uploadButton = document.getElementById('uploadButton');
        const dropArea = document.querySelector('.drop-area');
        const statusMessageDiv = document.getElementById('statusMessage');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const uploaderNameInput = document.getElementById('uploader-name');

        // GESTIONE SELEZIONE FILE (SENZA CONFLITTI DI CLICK)
        // 1. Click sul riquadro -> trigger input nascosto
        dropArea.addEventListener('click', (e) => {
            // Evita loop se si clicca su elementi interni che propagano
            if(e.target !== mediaFileInput) {
                mediaFileInput.click();
            }
        });

        // 2. Drag & Drop visivo
        dropArea.addEventListener('dragover', (e) => { 
            e.preventDefault(); 
            dropArea.classList.add('highlight', 'border-[var(--color-primary)]', 'bg-green-50'); 
        });
        dropArea.addEventListener('dragleave', (e) => { 
            e.preventDefault(); 
            dropArea.classList.remove('highlight', 'border-[var(--color-primary)]', 'bg-green-50'); 
        });
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault(); 
            dropArea.classList.remove('highlight', 'border-[var(--color-primary)]', 'bg-green-50');
            
            // Gestione drop dei file
            if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                handleNewFiles(e.dataTransfer.files);
            }
        });
        
        // 3. Cambio Input (Selezione classica)
        mediaFileInput.addEventListener('click', (e) => {
             // Reset del valore per permettere di riselezionare lo stesso file se necessario
             // ma attenzione: questo resetta la lista corrente dell'input nativo
             e.target.value = null; 
        });
        
        mediaFileInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files.length > 0) {
                handleNewFiles(e.target.files);
            }
        });

        // Array per accumulare i file (così non si resettano ogni volta che ne aggiungi uno)
        let allSelectedFiles = [];

        function handleNewFiles(newFiles) {
            statusMessageDiv.classList.add('hidden');
            progressBarContainer.classList.add('hidden');
            progressText.classList.add('hidden');
            
            let rejected = false;
            
            Array.from(newFiles).forEach(file => {
                const sizeMB = file.size / (1024 * 1024);
                // Controllo duplicati base (nome + size)
                const exists = allSelectedFiles.some(f => f.name === file.name && f.size === file.size);
                
                if (sizeMB > 5) {
                    rejected = true;
                } else if (!exists) {
                    allSelectedFiles.push(file);
                }
            });

            if (rejected) {
                alert("Alcuni file sono stati ignorati perché superano i 5MB.");
            }

            updateFileInfoUI();
        }

        function updateFileInfoUI() {
            if (allSelectedFiles.length === 0) {
                fileInfoDiv.classList.add('hidden');
                uploadButton.disabled = true;
                uploadButton.innerHTML = 'Carica Foto';
                return;
            }

            const totalSizeMB = allSelectedFiles.reduce((acc, f) => acc + f.size, 0) / (1024 * 1024);
            
            fileInfoDiv.innerHTML = `
                <div class="font-bold text-gray-700 mb-2">${allSelectedFiles.length} file selezionati (${totalSizeMB.toFixed(2)} MB):</div>
                <ul class="text-xs text-left text-gray-500 max-h-32 overflow-y-auto border p-2 rounded bg-gray-50">
                    ${allSelectedFiles.map(f => `<li>• ${f.name}</li>`).join('')}
                </ul>
                <button type="button" id="clearFiles" class="text-red-500 text-xs underline mt-2">Rimuovi tutto</button>
            `;
            
            fileInfoDiv.classList.remove('hidden');
            uploadButton.disabled = false;
            
            document.getElementById('clearFiles').addEventListener('click', (e) => {
                e.stopPropagation(); // Evita di riaprire il dialog
                allSelectedFiles = [];
                updateFileInfoUI();
            });
        }

        // Funzione per convertire file in Base64 (Necessario per Apps Script)
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]); // Rimuove header data:image/png;base64,
            reader.onerror = error => reject(error);
        });

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // --- CONTROLLO URL SCRIPT ---
            // Controllo specifico per l'errore comune dell'utente
            if (GOOGLE_SCRIPT_URL.includes("script.google.com") && GOOGLE_SCRIPT_URL.includes("/edit")) {
                 statusMessageDiv.classList.remove('hidden', 'bg-green-100', 'text-green-700');
                 statusMessageDiv.classList.add('bg-red-100', 'text-red-700');
                 statusMessageDiv.innerHTML = `
                    <strong>⚠️ Link Errato!</strong><br>
                    Hai inserito il link dell'editor (che finisce con <code>/edit</code>).<br>
                    Devi inserire il link della Web App Pubblicata (che finisce con <code>/exec</code>).<br>
                    Segui le istruzioni sopra per generare il link corretto.
                `;
                return;
            }

            if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.length < 10) {
                statusMessageDiv.classList.remove('hidden', 'bg-green-100', 'text-green-700');
                statusMessageDiv.classList.add('bg-red-100', 'text-red-700');
                statusMessageDiv.innerHTML = `
                    <strong>⚠️ Configurazione Mancante!</strong><br>
                    Sembra che tu non abbia incollato l'URL di Google Apps Script nel codice.<br>
                    Apri l'editor, cerca la riga <code>const GOOGLE_SCRIPT_URL = '';</code> e incolla l'indirizzo.
                `;
                return;
            }

            if (allSelectedFiles.length === 0) return;

            uploadButton.disabled = true;
            uploadButton.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> Preparazione...';
            statusMessageDiv.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-blue-100', 'text-blue-700');
            statusMessageDiv.classList.add('bg-blue-100', 'text-blue-700');
            statusMessageDiv.textContent = `Avvio caricamento di ${allSelectedFiles.length} file...`;
            
            progressBarContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressText.classList.remove('hidden');

            try {
                let successCount = 0;
                const uploaderName = uploaderNameInput.value.trim() || 'Ospite Anonimo';

                for (let i = 0; i < allSelectedFiles.length; i++) {
                    const file = allSelectedFiles[i];
                    const fileData = await toBase64(file);
                    
                    uploadButton.innerHTML = `<i class="fas fa-upload mr-2"></i> Carico ${i+1}/${allSelectedFiles.length}...`;
                    
                    const payload = {
                        fileName: file.name,
                        mimeType: file.type,
                        fileData: fileData,
                        uploaderName: uploaderName
                    };

                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', // Importante per Apps Script
                        body: JSON.stringify(payload)
                    });

                    successCount++;
                    const percent = Math.round((successCount / allSelectedFiles.length) * 100);
                    progressBar.style.width = `${percent}%`;
                    progressText.textContent = `${percent}% Completato`;
                }

                statusMessageDiv.classList.remove('bg-blue-100', 'text-blue-700');
                statusMessageDiv.classList.add('bg-green-100', 'text-green-700');
                statusMessageDiv.innerHTML = `✅ Tutte le foto sono state caricate! Grazie.`;
                
                // Reset
                allSelectedFiles = [];
                updateFileInfoUI();
                mediaFileInput.value = ''; 
                uploaderNameInput.value = '';
                uploadButton.innerHTML = 'Caricamento Completato';

            } catch (error) {
                console.error("Errore di caricamento:", error);
                uploadButton.disabled = false;
                uploadButton.innerHTML = '<i class="fas fa-times-circle mr-2"></i> Riprova';
                statusMessageDiv.classList.remove('bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
                statusMessageDiv.classList.add('bg-red-100', 'text-red-700');
                statusMessageDiv.textContent = `❌ Errore durante l'upload: ${error.message}`;
            }
        });
    </script>
</body>
</html>
