<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">

    <title>Siete invitati | Elena & Ugo</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap');
        
        :root {
            --color-primary: #5D7050;      
            --color-secondary: #C4D2B2;    
            --color-accent: #E8B446;       
            --color-background: #FAF8F2;   
            --font-serif: 'Playfair Display', serif;
            --font-sans: 'Inter', sans-serif;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--color-background);
            color: #222;
            -webkit-font-smoothing: antialiased;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        a, button, input, select, textarea { -webkit-tap-highlight-color: transparent; }
        input, textarea, select, button { -webkit-appearance: none; appearance: none; border-radius: 0.375rem; }
        
        .header-font { font-family: var(--font-serif); }

        .wedding-bg {
            position: relative;
            min-height: 100vh;
            z-index: 1; 
            overflow: hidden; 
        }
        
        .wedding-bg::before {
            content: '';
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100vh; 
            background: url('https://images.unsplash.com/photo-1561287495-a3fe1fd28504?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w3NDE5ODJ8MHwxfHNlYXJjaHw5fHx3ZWRkaW5nJTIwY291cGxlfGVufDB8fHx8MTc2MzIzODI3MHww&ixlib=rb-4.1.0&q=80&q=75&w=1080') center/cover no-repeat;
            background-attachment: scroll; 
            filter: blur(3px); 
            z-index: -1; 
            transform: translateZ(0); 
        }
        
        .glass-box {
            position: relative; z-index: 2;
            background-color: rgba(255, 255, 255, 0.5); 
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #222; 
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .btn-primary:hover {
            background-color: #4A5B3E;
            box-shadow: 0 4px 15px rgba(93, 112, 80, 0.5);
            transform: translateY(-2px);
        }
        .btn-primary:active { transform: translateY(0); }

        .drop-area {
            border: 4px dashed var(--color-secondary);
            background-color: #ffffff;
            transition: all 0.2s;
        }
        .drop-area.highlight {
            border-color: var(--color-primary);
            background-color: #f7f9f7;
        }

        /* Stili per la Galleria */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }
        .gallery-item {
            position: relative;
            aspect-ratio: 1; /* Quadrato */
            overflow: hidden;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            background-color: #eee;
            cursor: pointer;
        }
        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }
        .gallery-item:hover img {
            transform: scale(1.05);
        }
        .video-badge {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            padding: 10px;
            font-size: 20px;
        }
    </style>
</head>
<body class="scroll-smooth">

    <!-- HEADER -->
    <header class="wedding-bg flex flex-col justify-center items-center p-8 text-center" id="home">
        <div class="glass-box p-8 md:p-12 max-w-lg w-full rounded-2xl shadow-2xl"> 
            <p class="text-xl text-gray-800 mb-2 header-font italic">Siete invitati al matrimonio di</p>
            <h1 class="header-font text-5xl md:text-7xl text-[var(--color-primary)] font-bold mb-6 tracking-tight leading-none flex justify-center items-center flex-wrap">
                <span>Elena</span> <span class="text-gray-600 font-normal mx-3 text-5xl md:text-7xl">&</span> <span>Ugo</span>
            </h1>
            <p class="text-2xl text-gray-800 font-medium mb-12">30 Maggio 2026</p>
            <div id="countdown" class="flex justify-center space-x-4 md:space-x-8 text-gray-800 bg-white p-4 rounded-lg shadow-xl">
                <div class="flex flex-col items-center"><span id="days" class="text-3xl font-bold text-[var(--color-primary)]">00</span><span class="text-xs uppercase mt-1">Giorni</span></div>
                <div class="flex flex-col items-center"><span id="hours" class="text-3xl font-bold text-[var(--color-primary)]">00</span><span class="text-xs uppercase mt-1">Ore</span></div>
                <div class="flex flex-col items-center"><span id="minutes" class="text-3xl font-bold text-[var(--color-primary)]">00</span><span class="text-xs uppercase mt-1">Minuti</span></div>
                <div class="flex flex-col items-center"><span id="seconds" class="text-3xl font-bold text-[var(--color-primary)]">00</span><span class="text-xs uppercase mt-1">Secondi</span></div>
            </div>
            <p id="countdown-message" class="text-lg mt-4 font-semibold text-[var(--color-primary)] hidden">È IL GRANDE GIORNO!</p>
        </div>
    </header>

    <!-- NAV -->
    <nav class="sticky top-0 z-50 bg-white/90 backdrop-blur-md shadow-lg border-t-4 border-[var(--color-primary)] supports-[backdrop-filter]:bg-white/60">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-center h-16">
                <a href="#info" class="text-gray-600 hover:text-[var(--color-primary)] px-5 py-2 rounded-md text-base font-medium transition duration-150 flex items-center h-full">Info</a>
                <a href="#guestbook" class="text-gray-600 hover:text-[var(--color-primary)] px-5 py-2 rounded-md text-base font-medium transition duration-150 flex items-center h-full">RSVP</a>
                <a href="#upload-foto" class="text-gray-600 hover:text-[var(--color-primary)] px-5 py-2 rounded-md text-base font-medium transition duration-150 flex items-center h-full">Foto</a>
            </div>
        </div>
    </nav>

    <!-- INFO -->
    <section id="info" class="py-16 md:py-24 bg-[var(--color-background)] relative z-10">
        <div class="max-w-5xl mx-auto px-4 text-center">
            <h2 class="header-font text-4xl md:text-5xl font-bold mb-12 text-gray-800 border-b-2 border-[var(--color-primary)] inline-block pb-2">Informazioni Utili</h2>
            <div class="space-y-8">
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="bg-white p-8 rounded-xl shadow-lg border-t-4 border-[var(--color-secondary)]">
                        <i class="fas fa-handshake text-4xl text-[var(--color-primary)] mb-4"></i>
                        <h3 class="header-font text-3xl font-semibold mb-3">Cerimonia</h3>
                        <p class="text-gray-600 mb-2 font-medium">Ore 12:00</p>
                        <p class="text-gray-600 mb-4 font-bold">Ristorante Symposio</p>
                        <p class="text-sm text-gray-500">Via Loreggiola, 163, 35010 Loreggia PD</p>
                    </div>
                    <div class="bg-white p-8 rounded-xl shadow-lg border-t-4 border-[var(--color-primary)]">
                        <i class="fas fa-glass-cheers text-4xl text-[var(--color-primary)] mb-4"></i>
                        <h3 class="header-font text-3xl font-semibold mb-3">Ricevimento</h3>
                        <p class="text-gray-600 mb-2 font-medium">A seguire (Ore 14:00)</p>
                        <p class="text-gray-600 mb-4 font-bold">Ristorante Symposio</p>
                        <p class="text-sm text-gray-500">Via Loreggiola, 163, 35010 Loreggia PD</p>
                    </div>
                </div>
                <div class="flex justify-center pt-4">
                    <div class="w-full md:w-2/3 lg:w-1/2">
                        <div class="bg-white p-8 rounded-xl shadow-lg border-t-4 border-[var(--color-secondary)]">
                            <i class="fas fa-gift text-4xl text-[var(--color-primary)] mb-4"></i>
                            <h3 class="header-font text-3xl font-semibold mb-3">Un piccolo pensiero</h3>
                            <p class="text-gray-600 mb-6 text-sm">La vostra presenza è il regalo più grande! Ma se desiderate farci un pensiero, gradiremmo un contributo per la nostra luna di miele da sogno.</p>
                            <button onclick="document.getElementById('iban_details').classList.toggle('hidden')" class="btn-primary py-2 px-6 rounded-full font-bold shadow-md hover:shadow-xl transition duration-300 text-sm w-full sm:w-auto">Vedi Dettagli IBAN</button>
                            <div id="iban_details" class="mt-4 p-3 bg-gray-100 rounded-lg hidden text-left"><p class="text-sm font-mono break-all">IT00 A000 0000 0000 0000 0000 00</p></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- RSVP -->
    <section id="guestbook" class="py-16 md:py-24 bg-[var(--color-background)] relative z-10">
        <div class="max-w-5xl mx-auto px-4 text-center">
            <h2 class="header-font text-4xl md:text-5xl font-bold mb-12 text-gray-800 border-b-2 border-[var(--color-primary)] inline-block pb-2">Conferma Presenza</h2>
            <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-3xl mx-auto">
                <div id="rsvp-content">
                    <form id="rsvp-form" class="space-y-4 text-left">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Nome</label>
                            <input type="text" id="guest-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700">Adulti</label><input type="number" id="adult-count" required min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3"></div>
                            <div><label class="block text-sm font-medium text-gray-700">Bambini</label><input type="number" id="children-count" required min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3"></div>
                        </div>
                        <div id="individual-guests-container" class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200"></div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Note</label>
                            <textarea id="guest-message" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3"></textarea>
                        </div>
                        <button type="submit" id="submitRsvp" class="btn-primary w-full py-3 mt-4 rounded-full font-bold text-lg">Invia Conferma</button>
                    </form>
                    <div id="status-message-guestbook" class="mt-4 p-3 rounded-md hidden"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- UPLOAD FOTO + GALLERIA -->
    <section id="upload-foto" class="py-16 md:py-24 bg-white relative z-10">
        <div class="max-w-3xl mx-auto px-4 text-center">
            <h2 class="header-font text-4xl md:text-5xl font-bold mb-12 text-gray-800 border-b-2 border-[var(--color-primary)] inline-block pb-2">Condividi le tue Foto!</h2>
            
            <!-- FORM UPLOAD -->
            <form id="uploadForm" class="bg-[var(--color-background)] p-6 md:p-8 rounded-xl shadow-2xl space-y-4 text-left mb-16">
                <div class="drop-area flex flex-col items-center justify-center p-8 md:p-12 text-center rounded-lg cursor-pointer active:bg-gray-100 transition border-4 border-dashed border-[var(--color-secondary)] hover:border-[var(--color-primary)] bg-white">
                    <i class="fas fa-cloud-upload-alt text-4xl text-[var(--color-primary)] mb-4"></i>
                    <p class="font-semibold text-gray-700">Tocca qui per caricare</p>
                    <input type="file" id="mediaFile" name="mediaFile" accept="image/*,video/*" class="hidden" multiple>
                    <button type="button" id="btnSelectFiles" class="btn-primary py-2 px-6 rounded-full font-bold mt-4 shadow-md text-sm pointer-events-none">Scegli dalla Galleria</button>
                </div>
                <div id="file-info" class="text-sm text-gray-600 text-center pt-2 hidden"></div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Il tuo Nome</label>
                    <input type="text" id="uploader-name" placeholder="Es. Giuseppe Verdi" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3">
                </div>
                <button type="submit" id="uploadButton" class="btn-primary w-full py-3 mt-4 rounded-full font-bold text-lg" disabled>Carica Foto</button>
                <div id="statusMessage" class="mt-4 p-3 rounded-md hidden text-center text-sm font-medium"></div>
                <div id="progress-bar-container" class="w-full h-3 rounded-full overflow-hidden mt-4 hidden bg-gray-200">
                    <div id="progress-bar" class="h-full transition-all duration-300" style="width: 0%; background-color: var(--color-primary);"></div>
                </div>
                <p id="progress-text" class="text-sm text-gray-600 mt-2 text-center hidden"></p>
            </form>

            <!-- GALLERIA LIVE -->
            <div id="gallery-section">
                <h3 class="text-3xl font-bold text-gray-800 mb-6">Galleria in Tempo Reale</h3>
                <p class="text-gray-600 mb-8">Ecco gli ultimi scatti caricati dagli ospiti. Clicca per vedere a schermo intero.</p>
                
                <div id="gallery-loader" class="text-[var(--color-primary)] animate-pulse mb-8">
                    <i class="fas fa-circle-notch fa-spin mr-2"></i> Caricamento galleria...
                </div>

                <div id="gallery-grid" class="gallery-grid">
                    <!-- Le foto verranno inserite qui via JS -->
                </div>
                
                <div id="gallery-error" class="hidden text-red-500 bg-red-50 p-4 rounded-lg mt-4"></div>
                
                <button id="refreshGallery" class="mt-8 text-[var(--color-primary)] hover:text-[var(--color-accent)] font-semibold underline">
                    <i class="fas fa-sync-alt mr-1"></i> Aggiorna Galleria
                </button>
            </div>
        </div>
    </section>
    
    <!-- FOOTER -->
    <footer class="bg-gray-800 text-white p-8 text-center relative z-10">
        <p class="text-sm">&copy; 2024 Elena & Ugo.</p>
    </footer>
    
    <script type="module">
        // --- CONFIGURAZIONE ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyg88WvGvGzDKxEp9aRrlna9MJrTM2xcEI98xLuR7hGg0n0gZHFzi3h4j6O4kuU0-4CcA/exec'; 
        
        const appId = 'wedding-app-default';
        let userId = 'AnonGuest_' + crypto.randomUUID(); 
        let mockRsvpDataStore = [];
        const targetDate = new Date("May 30, 2026 12:00:00").getTime(); 

        // Countdown
        const updateCountdown = () => {
            const now = new Date().getTime(), distance = targetDate - now;
            if (distance < 0) { document.getElementById('countdown').classList.add('hidden'); document.getElementById('countdown-message').classList.remove('hidden'); return; }
            document.getElementById('days').textContent = Math.floor(distance / (1000 * 60 * 60 * 24)).toString().padStart(2, '0');
            document.getElementById('hours').textContent = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)).toString().padStart(2, '0');
            document.getElementById('minutes').textContent = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
            document.getElementById('seconds').textContent = Math.floor((distance % (1000 * 60)) / 1000).toString().padStart(2, '0');
        };
        setInterval(updateCountdown, 1000); updateCountdown();

        // RSVP Logic (Semplificata per brevità)
        const adultCountInput = document.getElementById('adult-count'), childrenCountInput = document.getElementById('children-count'), guestsContainer = document.getElementById('individual-guests-container');
        function updateIndividualGuestFields() {
            const total = (parseInt(adultCountInput.value)||0) + (parseInt(childrenCountInput.value)||0);
            guestsContainer.innerHTML = total === 0 ? '<p class="text-sm text-gray-500 text-center">Inserisci numero ospiti.</p>' : '';
            if(total > 0) {
                const title = document.createElement('h4'); title.className='text-lg font-semibold mb-2'; title.textContent=`Dettagli per ${total} persone`; guestsContainer.appendChild(title);
                for(let i=0; i<total; i++) {
                    const div = document.createElement('div'); div.className='mb-2 border-l-4 border-[var(--color-secondary)] p-2 bg-white';
                    div.innerHTML = `<input type="text" placeholder="Nome ospite ${i+1}" class="w-full p-2 border rounded text-sm">`;
                    guestsContainer.appendChild(div);
                }
            }
        }
        adultCountInput.addEventListener('change', updateIndividualGuestFields);
        childrenCountInput.addEventListener('change', updateIndividualGuestFields);
        document.getElementById('rsvp-form').addEventListener('submit', (e) => { e.preventDefault(); document.getElementById('submitRsvp').innerHTML='<i class="fas fa-check"></i> Inviato!'; setTimeout(()=>document.getElementById('submitRsvp').innerHTML='Invia Conferma', 3000); });

        // --- UPLOAD LOGIC ---
        const mediaFileInput = document.getElementById('mediaFile'), uploadButton = document.getElementById('uploadButton'), dropArea = document.querySelector('.drop-area');
        const statusMessage = document.getElementById('statusMessage'), progressBar = document.getElementById('progress-bar'), fileInfo = document.getElementById('file-info');
        let allSelectedFiles = [];

        dropArea.addEventListener('click', (e) => { if(e.target !== mediaFileInput) mediaFileInput.click(); });
        dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.classList.add('highlight'); });
        dropArea.addEventListener('dragleave', (e) => { e.preventDefault(); dropArea.classList.remove('highlight'); });
        dropArea.addEventListener('drop', (e) => { e.preventDefault(); dropArea.classList.remove('highlight'); if(e.dataTransfer.files.length) handleNewFiles(e.dataTransfer.files); });
        mediaFileInput.addEventListener('click', (e) => e.target.value = null);
        mediaFileInput.addEventListener('change', (e) => { if(e.target.files.length) handleNewFiles(e.target.files); });

        function handleNewFiles(files) {
            Array.from(files).forEach(f => { if(f.size < 5*1024*1024) allSelectedFiles.push(f); else alert("File troppo grande (Max 5MB): " + f.name); });
            if(allSelectedFiles.length) {
                fileInfo.textContent = `${allSelectedFiles.length} file pronti.`; fileInfo.classList.remove('hidden'); uploadButton.disabled = false;
            }
        }

        const toBase64 = file => new Promise((resolve, reject) => { const r = new FileReader(); r.readAsDataURL(file); r.onload=()=>resolve(r.result.split(',')[1]); r.onerror=reject; });

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!GOOGLE_SCRIPT_URL) { alert("Manca URL Script!"); return; }
            uploadButton.disabled = true; uploadButton.innerHTML = 'Caricamento...';
            document.getElementById('progress-bar-container').classList.remove('hidden');
            
            try {
                for(let i=0; i<allSelectedFiles.length; i++) {
                    const b64 = await toBase64(allSelectedFiles[i]);
                    await fetch(GOOGLE_SCRIPT_URL, { method:'POST', mode:'no-cors', body:JSON.stringify({ fileName:allSelectedFiles[i].name, mimeType:allSelectedFiles[i].type, fileData:b64, uploaderName:document.getElementById('uploader-name').value||'Anonimo' }) });
                    progressBar.style.width = `${Math.round(((i+1)/allSelectedFiles.length)*100)}%`;
                }
                statusMessage.innerHTML = '✅ Caricamento completato!'; statusMessage.classList.remove('hidden', 'text-red-500'); statusMessage.classList.add('text-green-600');
                allSelectedFiles = []; fileInfo.classList.add('hidden');
                
                // Aggiorna la galleria dopo l'upload
                setTimeout(fetchGallery, 2000);
                
            } catch(err) {
                statusMessage.innerHTML = '❌ Errore: ' + err.message; statusMessage.classList.remove('hidden');
            } finally {
                uploadButton.disabled = false; uploadButton.innerHTML = 'Carica Foto';
            }
        });

        // --- GALLERIA LOGIC (NUOVA) ---
        const galleryGrid = document.getElementById('gallery-grid');
        const galleryLoader = document.getElementById('gallery-loader');
        const galleryError = document.getElementById('gallery-error');

        async function fetchGallery() {
            galleryLoader.classList.remove('hidden');
            galleryError.classList.add('hidden');
            galleryGrid.innerHTML = '';

            try {
                // Chiamata GET allo script
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const files = await response.json();

                galleryLoader.classList.add('hidden');

                if (!files || files.length === 0) {
                    galleryGrid.innerHTML = '<p class="col-span-full text-center text-gray-500">Nessuna foto caricata finora. Sii il primo!</p>';
                    return;
                }

                files.forEach(file => {
                    const item = document.createElement('div');
                    item.className = 'gallery-item group';
                    
                    // URL per thumbnail ad alte prestazioni (non richiede Auth se il file è pubblico/Anyone with link)
                    const thumbUrl = `https://lh3.googleusercontent.com/d/${file.id}=s400`;
                    // URL per visualizzazione piena
                    const viewUrl = `https://drive.google.com/file/d/${file.id}/view`;

                    let content = `<img src="${thumbUrl}" loading="lazy" alt="${file.name}" onerror="this.src='https://via.placeholder.com/400x400?text=Caricamento...'">`;
                    
                    if (file.type === 'video') {
                        content += `<div class="video-badge"><i class="fas fa-play"></i></div>`;
                    }

                    // Link che apre in nuova scheda
                    item.innerHTML = `<a href="${viewUrl}" target="_blank">${content}</a>`;
                    galleryGrid.appendChild(item);
                });

            } catch (error) {
                console.error("Errore galleria:", error);
                galleryLoader.classList.add('hidden');
                galleryError.textContent = "Impossibile caricare la galleria. Controlla che lo script sia distribuito come 'Web App' con accesso 'Chiunque'.";
                galleryError.classList.remove('hidden');
            }
        }

        // Carica la galleria all'avvio
        if (GOOGLE_SCRIPT_URL && !GOOGLE_SCRIPT_URL.includes('/edit')) {
            fetchGallery();
        }
        
        document.getElementById('refreshGallery').addEventListener('click', fetchGallery);

    </script>
</body>
</html>
